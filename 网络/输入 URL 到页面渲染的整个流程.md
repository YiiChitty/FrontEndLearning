# 输入 URL 到页面渲染的整个流程

在看完网络部分其实我就很想写这个部分的，但后来想了想还是应该带上浏览器的内容一起。

**毕竟网络和浏览器不分家！！**



首先是**DNS解析**，

如果这一步做了智能 DNS 解析的话，会提供访问速度最快的 IP 地址回来，如果没有的话，会进行DNS迭代查询。

> 这个查询是操作系统自己做的。
>
> 当你在浏览器中想访问 `www.google.com` 时，会进行一下操作：
>
> 1. 操作系统会首先在本地缓存中查询 IP
> 2. 没有的话会去系统配置的 DNS 服务器中查询
> 3. 如果这时候还没得话，会直接去 DNS 根服务器查询，这一步查询会找出负责 `com` 这个一级域名的服务器
> 4. 然后去该服务器查询 `google` 这个二级域名
> 5. 接下来三级域名的查询其实是我们配置的，你可以给 `www` 这个域名配置一个 IP，然后还可以给别的三级域名配置一个 IP

之后就是**TCP握手**

TCP 的握手情况以及 TCP 的一些特性。

如果是https的话，还会 TCP 握手结束后就会进行 TLS 握手，然后就开始正式的传输数据。

**应用层会下发数据给传输层，这里 TCP 协议会指明两端的端口号，然后下发给网络层。网络层中的 IP 协议会确定 IP 地址，并且指示了数据传输中如何跳转路由器。然后包会再被封装到数据链路层的数据帧结构中，最后就是物理层面的传输了。**

**数据在进入服务端之前，可能还会先经过负责负载均衡的服务器，它的作用就是将请求合理的分发到多台服务器上，这时假设服务端会响应一个 HTML 文件。**

接收到响应的文件之后，**首先浏览器会判断状态码是什么**，如果是 200 那就继续解析，如果 400 或 500 的话就会报错，如果 300 的话会进行重定向

**浏览器开始解析文件**，如果是 gzip 格式的话会先解压一下，然后通过文件的编码格式知道该如何去解码文件。

文件解码成功后会正式开始**渲染流程**，先会根据 HTML 构建 DOM 树，有 CSS 的话会去构建 CSSOM 树。如果遇到 script 标签的话，会判断是否存在 async 或者 defer ，前者会并行进行下载并执行 JS，后者会先下载文件，然后等待 HTML 解析完成后顺序执行。如果以上都没有，就会阻塞住渲染流程直到 JS 执行完毕。

遇到文件下载的会去下载文件，这里如果使用 HTTP/2 协议的话会极大的提高多图的下载效率。

**CSSOM 树和 DOM 树构建完成后会开始生成 Render 树**，这一步就是确定页面元素的布局、样式等等诸多方面的东西

在生成 Render 树的过程中，浏览器就开始调用 GPU 绘制，合成图层，将内容显示在屏幕上了。

> 另外就是：
>
> `DOMContentLoaded`事件触发代表初始的HTML被完全加载和解析，不需要等待CSS，JS，图片加载。
>
> `Load`事件触发代表页面中的DOM，CSS，JS，图片已经全部加载完毕。

最后就是TCP断开连接，四次挥手。

> 客户端：我没有数据要发送了，准备挂了 
>
> 服务器：收到，但我还有一些数据没发送完，稍等一下 ...... 
>
> 服务器：好了，发送完了，可以断开连接了 
>
> 客户端：OK，你断开连接吧（内心独白：我将会在2倍的最大报文段生存时间后关闭连接，如果再收到服务器的消息，那么服务器就是没听到我最后这句话，我就再发送一遍）

